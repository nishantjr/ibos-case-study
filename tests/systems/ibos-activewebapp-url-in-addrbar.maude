load ../../systems/ibos-sop-pred-nou.maude --- contextual rewriting
load ../../systems/ibos-sop-fvp-noau.maude --- varsat
load ../../systems/ibos-sop-noau.maude     --- everything

set show advisories off .
set print attribute on .
---set print with parentheses on .

load ../../rltool.maude

---@ \/
---@ ({ < ui | toKernel(UIML) >
---@    < display | activeWebapp(none), displayedContent(about-blank) >
---@    < nic | in(mtLL), nic-out(mtLS) >
---@    < webappmgr | nextWPN(NWP) >
---@    < kernel | weblabels(mtWPIS), netlabels(mtNPIS), displayedTopBar(about-blank), handledCurrently(none), nextNPN(0),
---@        msgPolicy(policy(webapp, network,MSG-FETCH-URL ),ps
---@                  policy(ui,     webapp, MSG-NEW-URL   ),ps
---@ 		 policy(ui,     webapp, MSG-SWITCH-TAB),ps
---@ 		 policy(network,webapp, MSG-RETURN-URL)) > }) |
---@    true

--- activeWebapp's id and URL appear in weblabels(), URL appears in displayedTopBar()
--- NOTE: this property has expanded to encompass attributes:
---       display: activeWebapp, displayedContent
---       kernel: displayedTopBar, weblabels
---       webappmgr: nextWAN
--- NOTE: since we are not worried about ids of network processes here, the nextNetworkProc attribute probably doesn't matter
--- NOTE: due to the changeTab rule requiring synchronization between the weblabels attribute and the state of the system, we either need to:
---       [i]  use a recursive (non-FVP) predicate to describe the required relationship (strengthen the invariant + proof subcalculus to reason about it)
---       [ii] strengthen the changeTab rule in our specification by strengthening its condition
--- NOTE: These are not used anymore for
---/\ (in-conf?(W,C))                    = (false)    --- Now process W directly appears in the invariant state
---/\ (webapp-url-render?(W,C))          = ((U,RNDR)) --- This made the RNDR variable free, which causes problems, so now it appears in the state
---/\ (conf-labels-eqset?((C < W | none >) !c,WIS,NIS))           = (true)     --- ensure WIS and C are consistent


(select     IBOS-SOP-NOID .)
(use tool conrew  for validity         on IBOS-SOP-PRED-NOID with FOFORMSIMPLIFY-IMP-IMPL .)
(use tool conrew  for unsatisfiability on IBOS-SOP-PRED-NOID .)
(use tool varunif for varunif          on IBOS-SOP-FVP-NOID  .)

--- Sovled rules:
--- new-url
--- tab-change
--- change-display
--- fetch
--- render
--- proc-in
--- request-from-webapp

--- Unsovled rules:
--- proc-out

(select-rls request-from-webapp .)

(declare-vars (C:Configuration) U (NWC:NetWebProcConfig) U (WIS:WebProcInfoSet) U (NIS:NetProcInfoSet) U (MSG?:Message?) U
              (NNP:Nat) U (NWP:Nat) U (CURR:Label) U (B:Bool) U (B':Bool) U (UIML:MessageList) U
	      (DISP:Label) U (NICIN:LabelList) U (NICOUT:LabelSet) U (NI:ConcNetProcId) U (NI?:NetProcId) U
	      (F:MessageList) U (T:MessageList) U (D:Label) U (L:Bool) U (U:Label) U (U':Label) U (U2:Label) U (IN:Label) U (IN2:Label) U (OUT:Label) U (OUT2:Label) U
	      (A:AttributeSet) U (A':AttributeSet) U (A'':AttributeSet) U (MT:MsgType) U (LL:LabelList) U (RNDR:Label) U
	      (NWI:ConcNetWebProcId) U (WI:ConcWebProcId) U (WI':ConcWebProcId) U (PP1:ConcPipeId) U (GPPI:PipeId) .)
(def-term-set ([C:Configuration]) | true .)
(inv abc to '`[_`] on
({ NWC
   --- < WI | URL(U), rendered(RNDR), A >
   < ui | toKernel(UIML) >
   < display | activeWebapp(WI), displayedContent(DISP) >
   < nic | in(NICIN), nic-out(NICOUT) >
   < webappmgr | nextWPN(NWP) >
   < kernel | weblabels(WIS), netlabels(NIS), displayedTopBar(CURR), handledCurrently(MSG?), nextNPN(NNP),
       msgPolicy(policy(webapp, network,MSG-FETCH-URL ),ps
                 policy(ui,     webapp, MSG-NEW-URL   ),ps
		 policy(ui,     webapp, MSG-SWITCH-TAB),ps
		 policy(network,webapp, MSG-RETURN-URL)) > }) |
   (p(NWC,WIS,NIS,MSG?))                                          = (true)  /\
   (nwp-reqattrs?(NWC !c))                                        = (true)  /\
   (conf-attr-dupl?(NWC !c))                                      = (false) /\
   (conf-labels-eqset?(NWC,WIS,NIS))                              = (true)  /\
   (weblabels-dupl?(WIS))                                         = (false) /\
   (netlabels-dupl?(NIS))                                         = (false) /\
   (conf-dupl?(NWC))                                              = (false) /\
   (fresh-wp-id?(webapp(NWP), NWC))                               = (true)  /\
   (fresh-np-id?(network(NNP),NWC))                               = (true)  /\
   (fresh-weblabel?(webapp(NWP),WIS))                             = (true)  /\
   (fresh-netlabel?(network(NNP),NIS))                            = (true)  /\
   ---
   (netlabels-match?(NIS))                                        = (true)  /\
   (webapp-url-eqset?(NWC,WIS))                                   = (true)  /\
   (weblabel-by-pid(WI,WIS) ~l CURR)                              = (true)  /\
   (display-topbar-consistent?(WI,DISP,CURR,NWC))                 = (true)  /\
   (render-consistent?(NWC))                                      = (true)
   ---@ (DISP blank-or-equal RNDR)                                     = (true)  /\
   ---@ (U ~l CURR)                                                    = (true)  /\
.)

set print conceal on .
print conceal fmod_is_sorts_.____endfm mod_is_sorts_._____endm _;;_ . --- _;_ _`[_`] . --- _&&_ _|_

(start-proof .)
(auto .)

--- new-url, change-display
--- (auto .)

--- tab-change
--- (split ({ < WI | A > < kernel | weblabels(pi(WI,U),wp pi(WI',U'),wp WIS), A' > C }) by (webapp-url-render(WI',C)) = ((U,RNDR)) and (webapp-url-render(WI',C)) = (nopair) .)
--- (split ({ < WI | URL(U), A > < display | activeWebapp(WI), A' > < kernel | displayedTopBar(U'), A'' > C }) by (U ~l U') = (true) and (U ~l U') = (false) .)
--- (auto .)

--- fetch
--- (split ({ < WI | loading(B), URL(U), A > < kernel | weblabels(WIS), A' > C }) by (weblabel-by-pid(WI,WIS)) = (U) and (weblabel-by-pid(WI,WIS)) = (nolabel) .)
--- (split ({ < WI | A > < WI' | A' > C }) by (WI ~p WI') = (true) and (WI ~p WI') = (false) .)
--- (auto .)

--- (split ({ < W | loading(B), URL(U), A > < kernel | weblabels(WIS), A' > C }) by (weblabel-by-pid(W,WIS)) = (U) and (weblabel-by-pid(W,WIS)) = (nolabel) .)
--- (split ({ < W | A > < W' | A' > C }) by (W ~p W') = (true) and (W ~p W') = (false) .)
--- (auto .)

--- render --- single process
--- (focus 240 -- 247, 252 -- 259 .)
--- (split ({ < WI | loading(true), A > < kernel | weblabels(WIS), A' > C }) by (weblabel-by-pid(WI,WIS)) = (IN) and (weblabel-by-pid(WI,WIS)) = (nolabel) .)
--- (split ({ C }) | (p(< WI | fromKernel(msg(PP1,WI,MSG-RETURN-URL,U) @ F), A > NWC,WIS,NIS,MSG?)) = (true) by (netlabelpair-by-pid(PP1,NIS)) = ((IN,OUT)) and (netlabelpair-by-pid(PP1,NIS)) = (nopair) .)
--- (split ({ C }) | (p(< WI | fromKernel(msg(PP1,WI,MSG-RETURN-URL,U)    ), A > NWC,WIS,NIS,MSG?)) = (true) by (netlabelpair-by-pid(PP1,NIS)) = ((IN,OUT)) and (netlabelpair-by-pid(PP1,NIS)) = (nopair) .)
--- (split ({ < WI | loading(true), A > < kernel | weblabels(pi(WI,IN),wp WIS), netlabels(pi(NI,IN2,OUT),np NIS), A' > C }) by (IN ~l IN2) = (true) and (IN ~l IN2) = (false) .)
--- (split ({ < WI | loading(true), rendered(U), A > < kernel | netlabels(pi(NI,IN,OUT),np NIS), A' > C }) by (U ~l OUT) = (true) and (U ~l OUT) = (false) .)
--- (split ({ < kernel | netlabels(pi(NI,IN2,OUT),np NIS), A > C }) by (IN2 ~l OUT) = (true) and (IN2 ~l OUT) = (false) .)
--- (split ({ C }) | (render-consistent?(< WI | URL(U), rendered(U'), A > NWC)) = (true) by (U' blank-or-equal U) = (true) and (U' blank-or-equal U) = (false) .)
--- (auto .)

--- render --- multi process
--- (focus 248 -- 251, 260 -- 263 .)
--- (split ({ < WI | loading(true),         A > < kernel | weblabels(             WIS), A' > C }) by (weblabel-by-pid(WI,WIS)) = (IN) and (weblabel-by-pid(WI,WIS)) = (nolabel) .)
--- (split ({ < WI | loading(true), URL(U), A > < kernel | weblabels(pi(WI,IN),wp WIS), A' > C }) by (U ~l IN) = (true) and (U ~l IN) = (false) .)
--- (split ({ C }) | (p(< WI | fromKernel(msg(PP1,WI,MSG-RETURN-URL,U) @ F), A > NWC,WIS,NIS,MSG?)) = (true) by (netlabelpair-by-pid(PP1,NIS)) = ((IN,OUT)) and (netlabelpair-by-pid(PP1,NIS)) = (nopair) .)
--- (split ({ C }) | (p(< WI | fromKernel(msg(PP1,WI,MSG-RETURN-URL,U)    ), A > NWC,WIS,NIS,MSG?)) = (true) by (netlabelpair-by-pid(PP1,NIS)) = ((IN,OUT)) and (netlabelpair-by-pid(PP1,NIS)) = (nopair) .)
--- (split ({ < WI | loading(true), A > < kernel | weblabels(pi(WI,IN),wp WIS), netlabels(pi(NI,IN2,OUT),np NIS), A' > C }) by (IN ~l IN2) = (true) and (IN ~l IN2) = (false) .)
--- (split ({ < WI | loading(true), rendered(U), A > < kernel | netlabels(pi(NI,IN,OUT),np NIS), A' > C }) by (U ~l OUT) = (true) and (U ~l OUT) = (false) .)
--- (split ({ < kernel | netlabels(pi(NI,IN2,OUT),np NIS), A > C }) by (IN2 ~l OUT) = (true) and (IN2 ~l OUT) = (false) .)
--- (split ({ C }) | (render-consistent?(< WI | URL(U),  rendered(U'), A > < WI' | A' > NWC)) = (true) by (U' blank-or-equal U) = (true) and (U' blank-or-equal U) = (false) .)
--- (split ({ C }) | (render-consistent?(< WI | URL(U),  rendered(U'), A' >             NWC)) = (true) by (U' blank-or-equal U) = (true) and (U' blank-or-equal U) = (false) .)
--- (split ({ < WI | A > < WI' | A' > C }) by (WI ~p WI') = (true) and (WI ~p WI') = (false) .)
--- (auto .)

--- request-from-webapp
--- --- netproc only occurs in netlabels once
--- (split ({ < NI | A > < kernel | netlabels(                 NIS), A' > C }) by (netlabelpair-by-pid(NI,NIS)) = ((IN , OUT)) and (netlabelpair-by-pid(NI,NIS)) = (nopair) .)
--- (split ({ < NI | A > < kernel | netlabels(pi(NI,IN,OUT),np NIS), A' > C }) by (netlabelpair-by-pid(NI,NIS)) = ((IN2,OUT2)) and (netlabelpair-by-pid(NI,NIS)) = (nopair) .)
--- --- outgoing matches netproc out
--- (split ({ < NI | out(LL ; U), A > < kernel | netlabels(pi(NI,IN,OUT),np NIS), A' > C }) by (U ~l OUT) = (true) and (U ~l OUT) = (false) .)
--- --- netproc labels match
--- (split ({ < kernel | netlabels(pi(NI,IN2,OUT),np NIS), A > C }) by (IN2 ~l OUT) = (true) and (IN2 ~l OUT) = (false) .)
--- --- only one copy of webproc in weblabels
--- (split ({ < NI | returnTo(PP1), A > < kernel | weblabels(WIS),              A' > C }) by (weblabel-by-pid(PP1,WIS)) = (IN)  and (weblabel-by-pid(PP1,WIS)) = (nolabel) .)
--- (split ({ < NI | returnTo(WI),  A > < kernel | weblabels(pi(WI,IN),wp WIS), A' > C }) by (weblabel-by-pid(WI, WIS)) = (IN2) and (weblabel-by-pid(WI, WIS)) = (nolabel) .)
--- --- netproc and webproc ids match
--- (split ({ < NI | returnTo(WI),  A > < kernel | weblabels(pi(WI,IN),wp WIS), netlabels(pi(NI,IN2,OUT),np NIS), A' > C }) by (IN ~l IN2) = (true) and (IN ~l IN2) = (false) .)
--- --- the webproc is loaded
--- (split ({ < NI | returnTo(PP1), A > C }) by (proc-loaded?(PP1,C)) = (true) and (proc-loaded?(PP1,C)) = (false) .)
--- --- the webprocs are not equal
--- (split ({ < kernel | weblabels(pi(WI,IN),wp pi(WI',IN2),wp WIS), A > C }) by (WI ~p WI') = (true) and (WI ~p WI') = (false) .)
--- (auto .)

--- proc-in
--- (split ({ < NI |             A > < kernel | netlabels(NIS),                  A' > C }) by (netlabelpair-by-pid(NI,NIS)) = ((IN,OUT)) and (netlabelpair-by-pid(NI,NIS)) = (nopair) .)
--- (split ({ < NI |             A > < kernel | netlabels(NIS), weblabels(WIS),  A' > C }) by (proc-loaded-ind?(NI,NIS,WIS,C)) = (true) and (proc-loaded-ind?(NI,NIS,WIS,C)) = (false) .)
--- (split ({ < NI | in(LL ; U), A > < kernel | netlabels(pi(NI,IN,OUT),np NIS), A' > C }) by (U  ~l OUT) = (true) and (U  ~l OUT) = (false) .)
--- (split ({ < NI |             A > < kernel | netlabels(pi(NI,IN,OUT),np NIS), A' > C }) by (IN ~l OUT) = (true) and (IN ~l OUT) = (false) .)
--- (auto .)

--- TODO: proc-out
